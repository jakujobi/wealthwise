{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>Messaging Center</h1>
  <div class="row">
    <div class="col-md-4">
      <button id="new-convo" class="btn btn-primary mb-3">New Conversation</button>
      <div class="list-group">
        {% for conv in conversations %}
          <a href="#" class="list-group-item list-group-item-action conversation-item" data-id="{{ conv.id }}">
            {{ conv.participants|join:", " }}<br><small class="text-muted">{{ conv.created_at }}</small>
          </a>
        {% empty %}
          <p>No conversations yet.</p>
        {% endfor %}
      </div>
    </div>
    <div class="col-md-8">
      <div id="chat-window" class="border rounded p-3" style="height: 500px; overflow-y: auto;">
        <p>Select a conversation to view messages.</p>
      </div>
      <div id="message-form" class="mt-2">
        <div class="input-group">
          <input type="text" id="message-input" class="form-control" placeholder="Type a message..." disabled>
          <button id="send-message" class="btn btn-success" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const items = document.querySelectorAll('.conversation-item');
  const chatWindow = document.getElementById('chat-window');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-message');
  let selectedConvo = null;
  const newConvoButton = document.getElementById('new-convo');

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  newConvoButton.addEventListener('click', function(e) {
    e.preventDefault();
    // Create a new conversation via API
    fetch('/messaging/api/conversations/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      }
    })
    .then(response => response.json())
    .then(data => {
      // Add new conversation to the list
      const convoList = document.querySelector('.list-group');
      const newConvoItem = document.createElement('a');
      newConvoItem.href = '#';
      newConvoItem.className = 'list-group-item list-group-item-action conversation-item';
      newConvoItem.dataset.id = data.id;
      newConvoItem.innerHTML = `New Conversation<br><small class="text-muted">${data.created_at}</small>`;
      convoList.appendChild(newConvoItem);
      // Add event listener to the new conversation item
      newConvoItem.addEventListener('click', function(e) {
        e.preventDefault();
        const convoId = this.dataset.id;
        selectedConvo = convoId;
        messageInput.disabled = false;
        sendButton.disabled = false;
        chatWindow.innerHTML = '<p>Loading conversation ' + convoId + '...</p>';
        // Fetch messages via AJAX
        fetch(`/messaging/api/conversations/${convoId}/messages/`)
          .then(response => response.json())
          .then(data => {
            chatWindow.innerHTML = '';
            data.forEach(msg => {
              const msgEl = document.createElement('div');
              msgEl.innerHTML = `<strong>${msg.sender}</strong>: ${msg.body} <br><small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>`;
              chatWindow.appendChild(msgEl);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
          });
      });
    });
  });

  items.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const convoId = this.dataset.id;
      selectedConvo = convoId;
      messageInput.disabled = false;
      sendButton.disabled = false;
      chatWindow.innerHTML = '<p>Loading conversation ' + convoId + '...</p>';
      // Fetch messages via AJAX
      fetch(`/messaging/api/conversations/${convoId}/messages/`)
        .then(response => response.json())
        .then(data => {
          chatWindow.innerHTML = '';
          data.forEach(msg => {
            const msgEl = document.createElement('div');
            msgEl.innerHTML = `<strong>${msg.sender}</strong>: ${msg.body} <br><small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>`;
            chatWindow.appendChild(msgEl);
          });
          chatWindow.scrollTop = chatWindow.scrollHeight;
        });
    });
  });

  // Send message
  sendButton.addEventListener('click', function(e) {
    e.preventDefault();
    if (!selectedConvo) return;
    const body = messageInput.value.trim();
    if (!body) return;
    fetch(`/messaging/api/conversations/${selectedConvo}/messages/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      credentials: 'same-origin',
      body: JSON.stringify({ body })
    })
    .then(response => response.json())
    .then(msg => {
      const msgEl = document.createElement('div');
      msgEl.innerHTML = `<strong>${msg.sender}</strong>: ${msg.body} <br><small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>`;
      chatWindow.appendChild(msgEl);
      messageInput.value = '';
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });
  });
});
</script>
{% endblock %}
